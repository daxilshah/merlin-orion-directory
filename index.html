<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merlin Orion Residents Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }

        .background-collage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            overflow: hidden;
        }

        .background-collage img,
        .background-collage .gradient {
            position: absolute;
            opacity: 0.2;
        }

        .background-collage img {
            object-fit: cover;
        }

        /* Existing image positions */
        .image-1 {
            top: 0;
            left: 0;
            width: 60%;
            height: 70%;
        }

        .image-2 {
            bottom: 0;
            right: 0;
            width: 50%;
            height: 60%;
        }

        .image-3 {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50%;
            height: 50%;
        }

        /* New gradient positions */
        .gradient-top-right {
            top: 0;
            right: 0;
            width: 40%;
            height: 40%;
            background: linear-gradient(to bottom left, #a5b4fc, transparent);
        }

        .gradient-bottom-left {
            bottom: 0;
            left: 0;
            width: 40%;
            height: 40%;
            background: linear-gradient(to top right, #a5b4fc, transparent);
        }

        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 10;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        .input-group input, .input-group select {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
            background-color: #fff;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4c51bf;
            box-shadow: 0 0 0 2px rgba(76, 81, 191, 0.2);
        }
        input::placeholder, select option:disabled {
            color: #a0a0a0;
        }
        .placeholder-color {
            color: #a0a0a0;
        }
        .resident-section {
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            position: relative;
            background-color: #f9fafb;
        }
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 2rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #2d3748;
        }
        .message-box-transition {
            transition: all 0.3s ease-in-out;
            opacity: 1;
            transform: translateY(0);
        }
        .message-box-hidden {
            opacity: 0;
            transform: translateY(-10px);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

<div class="background-collage">
    <img src="https://housing-images.n7net.in/012c1500/de401d85f773e7949cdfc64cd6aa27ad/v0/fs.jpeg" alt="Merlin Orion building entrance" class="image-1">
    <img src="https://housing-images.n7net.in/4f2250e8/567357597639a7fd15db7f98026bcc11/v0/fs/merlin_orion-paldi-ahmedabad-merlin_group.jpeg" alt="Merlin Orion exterior view" class="image-2">
    <img src="https://housing-images.n7net.in/012c1500/6a7cc6d71a141d5d9cf49a58433239f3/v0/fs.jpeg" alt="Merlin Orion common area" class="image-3">
    <div class="gradient gradient-top-right"></div>
    <div class="gradient gradient-bottom-left"></div>
</div>

<div id="appContainer" class="form-container">
    <div id="formView">
        <div class="flex flex-col items-center mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Merlin Orion Residents Directory</h1>
            <p class="text-gray-500">Please provide the details for your flat and all residents.</p>
        </div>
        <form id="residentForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group relative">
                    <label for="flatNumber" class="text-sm text-gray-600">Flat Number <span class="text-red-500">*</span></label>
                    <select id="flatNumber" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm
                                   focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 appearance-none">
                        <option value="" disabled selected>Select flat number</option>
                    </select>
                    <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 mt-4 flex items-center px-2 text-gray-700">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="input-group relative">
                    <label for="flatStatus" class="text-sm text-gray-600">Owner or Tenant? <span class="text-red-500">*</span></label>
                    <select id="flatStatus" required
                            class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm
                                   focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 appearance-none">
                        <option value="" disabled selected>Select status</option>
                        <option value="Owner">Owner</option>
                        <option value="Resident">Resident</option>
                    </select>
                    <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 mt-4 flex items-center px-2 text-gray-700">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
            <div id="residentsContainer" class="mt-8 space-y-6">
                </div>
            <div class="flex items-center justify-between mt-6">
                <button type="button" id="showDataBtn"
                        class="py-3 px-4 rounded-md text-sm font-semibold text-gray-800 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">
                    View Submitted Data
                </button>
                <div class="flex gap-4">
                    <button type="button" id="addResidentBtn"
                            class="py-3 px-4 rounded-md text-sm font-semibold text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors">
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Resident
                    </button>
                    <button type="submit"
                            class="py-3 px-4 rounded-md text-sm font-semibold text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors">
                        Submit Form
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div id="dataView" class="hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Submitted Data</h2>
        <div class="table-container">
            <table id="dataTable" class="min-w-full">
                <thead>
                    <tr>
                        <th class="px-6 py-3">Flat Number</th>
                        <th class="px-6 py-3">Status</th>
                        <th class="px-6 py-3">Residents</th>
                        <th class="px-6 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div class="flex justify-center mt-6 gap-4">
            <button id="exportDataBtn"
                    class="py-3 px-4 rounded-md text-sm font-semibold text-gray-800 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">
                Export to CSV
            </button>
            <button id="goBackBtn"
                    class="py-3 px-4 rounded-md text-sm font-semibold text-gray-800 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">
                Go Back
            </button>
        </div>
    </div>

    <div id="messageBox" class="hidden mt-4 p-4 rounded-md text-sm message-box-transition" role="alert"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    // NOTE: This is how Netlify will inject your environment variables.
    const firebaseConfig = {
      apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
      authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
      projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
      storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
      messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
      appId: import.meta.env.VITE_FIREBASE_APP_ID,
    };

    // Since this is a sandboxed environment, we'll continue to use the provided globals.
    // If you were deploying this code, you would use your own firebaseConfig.
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Firebase Initialization
    let app, auth, db;
    let isFirebaseReady = false;

    // UI Elements
    const residentForm = document.getElementById('residentForm');
    const addResidentBtn = document.getElementById('addResidentBtn');
    const residentsContainer = document.getElementById('residentsContainer');
    const messageBox = document.getElementById('messageBox');
    const formView = document.getElementById('formView');
    const dataView = document.getElementById('dataView');
    const showDataBtn = document.getElementById('showDataBtn');
    const goBackBtn = document.getElementById('goBackBtn');
    const dataTableBody = document.querySelector('#dataTable tbody');
    const flatNumberSelect = document.getElementById('flatNumber');
    const flatStatusSelect = document.getElementById('flatStatus');
    const exportDataBtn = document.getElementById('exportDataBtn');

    // Function to handle the placeholder color for select elements
    const updateSelectPlaceholderColor = (selectElement) => {
        if (!selectElement) return;
        if (selectElement.value === "") {
            selectElement.classList.add('placeholder-color');
        } else {
            selectElement.classList.remove('placeholder-color');
        }
    };

    // Function to display messages to the user
    function showMessage(message, type = "info") {
        messageBox.textContent = message;
        messageBox.classList.remove("hidden", "bg-green-100", "text-green-800", "bg-red-100", "text-red-800", "bg-sky-100", "text-sky-800", "message-box-hidden");

        if (type === "success") {
            messageBox.classList.add("bg-green-100", "text-green-800");
        } else if (type === "error") {
            messageBox.classList.add("bg-red-100", "text-red-800");
        } else {
            messageBox.classList.add("bg-sky-100", "text-sky-800");
        }

        // Use a timeout to add the hidden class and trigger transition
        setTimeout(() => {
            messageBox.classList.add("message-box-hidden");
        }, 3000);
        setTimeout(() => {
            messageBox.classList.add("hidden");
        }, 3300); // Allow time for transition
    }

    // Function to generate flat number options
    const generateFlatNumbers = () => {
        const flatNumbers = [];
        for (let floor = 1; floor <= 14; floor++) {
            for (let house = 1; house <= 4; house++) {
                flatNumbers.push(`${floor}${String(house).padStart(2, '0')}`);
            }
        }
        flatNumbers.forEach(flatNum => {
            const option = document.createElement('option');
            option.value = flatNum;
            option.textContent = flatNum;
            flatNumberSelect.appendChild(option);
        });
    };

    // Function to create a new resident section
    let residentCount = 0;
    const createResidentSection = (residentData = {}) => {
        residentCount++;
        const section = document.createElement('div');
        section.className = 'resident-section relative mt-4';
        section.innerHTML = `
            <h3 class="font-bold text-gray-700 mb-4 text-lg">Resident #${residentCount}</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="name${residentCount}" class="text-sm text-gray-600">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="name${residentCount}" placeholder="Full Name" required
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400
                                  focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"
                           value="${residentData.name || ''}">
                </div>
                <div class="input-group">
                    <label for="contact${residentCount}" class="text-sm text-gray-600">Contact Number</label>
                    <input type="tel" id="contact${residentCount}" placeholder="e.g., 9876543210"
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400
                                  focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"
                           value="${residentData.contact || ''}">
                </div>
                <div class="input-group">
                    <label for="dob${residentCount}" class="text-sm text-gray-600">Date of Birth</label>
                    <input type="date" id="dob${residentCount}"
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm
                                  focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"
                           value="${residentData.dob || ''}">
                </div>
                <div class="input-group relative">
                    <label for="bloodGroup${residentCount}" class="text-sm text-gray-600">Blood Group</label>
                    <select id="bloodGroup${residentCount}"
                           class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm
                                  focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 appearance-none">
                        <option value="" disabled selected>Select blood group</option>
                        <option value="A+" ${residentData.bloodGroup === 'A+' ? 'selected' : ''}>A+</option>
                        <option value="A-" ${residentData.bloodGroup === 'A-' ? 'selected' : ''}>A-</option>
                        <option value="B+" ${residentData.bloodGroup === 'B+' ? 'selected' : ''}>B+</option>
                        <option value="B-" ${residentData.bloodGroup === 'B-' ? 'selected' : ''}>B-</option>
                        <option value="AB+" ${residentData.bloodGroup === 'AB+' ? 'selected' : ''}>AB+</option>
                        <option value="AB-" ${residentData.bloodGroup === 'AB-' ? 'selected' : ''}>AB-</option>
                        <option value="O+" ${residentData.bloodGroup === 'O+' ? 'selected' : ''}>O+</option>
                        <option value="O-" ${residentData.bloodGroup === 'O-' ? 'selected' : ''}>O-</option>
                    </select>
                    <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 mt-4 flex items-center px-2 text-gray-700">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="primaryContact${residentCount}"
                           class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                           ${residentData.isPrimaryContact ? 'checked' : ''}>
                    <label for="primaryContact${residentCount}" class="text-sm text-gray-600">Is this a Primary Contact?</label>
                </div>
                <div class="input-group relative">
                    <label for="relation${residentCount}" class="text-sm text-gray-600">Relation to Primary Contact <span class="text-red-500">*</span></label>
                    <select id="relation${residentCount}"
                           class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm
                                  focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 appearance-none">
                        <option value="" disabled selected>Select relation</option>
                        <option value="Self" ${residentData.relation === 'Self' ? 'selected' : ''}>Self</option>
                        <option value="Spouse" ${residentData.relation === 'Spouse' ? 'selected' : ''}>Spouse</option>
                        <option value="Father" ${residentData.relation === 'Father' ? 'selected' : ''}>Father</option>
                        <option value="Mother" ${residentData.relation === 'Mother' ? 'selected' : ''}>Mother</option>
                        <option value="Daughter" ${residentData.relation === 'Daughter' ? 'selected' : ''}>Daughter</option>
                        <option value="Son" ${residentData.relation === 'Son' ? 'selected' : ''}>Son</option>
                        <option value="Brother" ${residentData.relation === 'Brother' ? 'selected' : ''}>Brother</option>
                        <option value="Sister" ${residentData.relation === 'Sister' ? 'selected' : ''}>Sister</option>
                        <option value="Other" ${residentData.relation === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                    <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 mt-4 flex items-center px-2 text-gray-700">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                <div class="input-group">
                        <label for="education${residentCount}" class="text-sm text-gray-600">Education</label>
                        <input type="text" id="education${residentCount}" placeholder="e.g., B.Tech, M.S."
                               class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400
                                      focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"
                               value="${residentData.education || ''}">
                    </div>
                    <div class="input-group">
                        <label for="occupation${residentCount}" class="text-sm text-gray-600">Occupation</label>
                        <input type="text" id="occupation${residentCount}" placeholder="e.g., Investment Banker, Software Engineer, Business"
                               class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400
                                      focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500"
                               value="${residentData.occupation || ''}">
                    </div>
                </div>
            </div>
            <button type="button" class="remove-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z" clip-rule="evenodd"></path></svg>
            </button>
        `;
        residentsContainer.appendChild(section);

        // Add event listener to the remove button
        section.querySelector('.remove-btn').addEventListener('click', () => {
            section.remove();
            // Recalculate resident numbers
            const sections = residentsContainer.querySelectorAll('.resident-section');
            residentCount = 0;
            sections.forEach((s) => {
                residentCount++;
                s.querySelector('h3').textContent = `Resident #${residentCount}`;
            });
        });

        // Handle date and select input placeholder color
        const dobInput = section.querySelector(`#dob${residentCount}`);
        const bloodGroupSelect = section.querySelector(`#bloodGroup${residentCount}`);
        const relationSelect = section.querySelector(`#relation${residentCount}`);

        const setDateColor = () => {
            if (!dobInput.value) {
                dobInput.classList.add('placeholder-color');
            } else {
                dobInput.classList.remove('placeholder-color');
            }
        };

        const updateSelects = () => {
            updateSelectPlaceholderColor(bloodGroupSelect);
            updateSelectPlaceholderColor(relationSelect);
        };

        // Set initial color on creation
        setDateColor();
        updateSelects();

        // Listen for changes
        dobInput.addEventListener('change', setDateColor);
        bloodGroupSelect.addEventListener('change', updateSelects);
        relationSelect.addEventListener('change', updateSelects);
    };

    // This function adds all event listeners after Firebase is ready.
    const setupEventListeners = () => {
        flatNumberSelect.addEventListener('change', async (e) => {
            const selectedFlatNumber = e.target.value;
            if (!isFirebaseReady || !auth.currentUser) {
                 console.log("Firebase is not ready yet.");
                 showMessage("Database is not ready. Please wait a moment and try again.", "info");
                 return;
             }

            try {
                const docRef = doc(db, 'residents', selectedFlatNumber);
                const docSnap = await getDoc(docRef);
                residentsContainer.innerHTML = ''; // Clear existing resident sections
                residentCount = 0;

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    flatStatusSelect.value = data.flatStatus;
                    const residentsArray = data.residents;
                    residentsArray.forEach(resident => createResidentSection(resident));
                } else {
                    // If no data exists, reset to one blank resident section
                    flatStatusSelect.value = "";
                    createResidentSection();
                }
                updateSelectPlaceholderColor(flatStatusSelect);
            } catch (error) {
                console.error("Error fetching document:", error);
                showMessage("An error occurred while loading data.", "error");
            }
        });

        addResidentBtn.addEventListener('click', createResidentSection);

        residentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log("Submit event handler triggered.");
        
            if (!isFirebaseReady || !auth.currentUser) {
                console.error("Firebase is not initialized or user is not authenticated.");
                showMessage("Database is not ready. Please try again.", "error");
                return;
            }
        
            // Get form data
            const flatNumber = document.getElementById('flatNumber').value;
            const flatStatus = document.getElementById('flatStatus').value;
            const residents = [];
            const residentSections = residentsContainer.querySelectorAll('.resident-section');
        
            residentSections.forEach((section, index) => {
                const name = section.querySelector(`#name${index + 1}`).value;
                const contact = section.querySelector(`#contact${index + 1}`).value;
                const dob = section.querySelector(`#dob${index + 1}`).value;
                const bloodGroup = section.querySelector(`#bloodGroup${index + 1}`).value;
                const occupation = section.querySelector(`#occupation${index + 1}`).value;
                const education = section.querySelector(`#education${index + 1}`).value;
                const isPrimaryContact = section.querySelector(`#primaryContact${index + 1}`).checked;
                const relation = section.querySelector(`#relation${index + 1}`).value;
        
                residents.push({
                    name,
                    contact,
                    dob,
                    bloodGroup,
                    occupation,
                    education,
                    isPrimaryContact,
                    relation
                });
            });
        
            const formData = {
                flatNumber,
                flatStatus,
                residents: residents,
                // USE THE SERVER TIMESTAMP INSTEAD OF NEW DATE()
                submissionTimestamp: serverTimestamp()
            };

            console.log('Submit formData', formData);
        
            try {
                // Use the flat number as the document ID for easy lookup
                const docRef = doc(db, 'residents', flatNumber);
                await setDoc(docRef, formData);
                console.log("Form data saved successfully!");
                showMessage("Form submitted successfully! Thank you for providing your information.", "success");
                residentForm.reset();
                // Clear and reset the resident sections
                residentsContainer.innerHTML = '';
                residentCount = 0;
                createResidentSection();
            } catch (error) {
                // Log the error to get a more specific reason for the failure
                console.error("Error writing document to Firestore: ", error);
                showMessage("An error occurred. Please try again.", "error");
            }
        });

        // View data functionality
        showDataBtn.addEventListener('click', () => {
            if (!isFirebaseReady || !auth.currentUser) {
                 console.log("Firebase is not ready yet.");
                 showMessage("Database is not ready. Please wait a moment and try again.", "info");
                 return;
             }
            formView.classList.add('hidden');
            dataView.classList.remove('hidden');
            loadData();
        });

        goBackBtn.addEventListener('click', () => {
            formView.classList.remove('hidden');
            dataView.classList.add('hidden');
        });

        exportDataBtn.addEventListener('click', async () => {
            if (!isFirebaseReady || !auth.currentUser) {
                showMessage("Database not ready. Cannot export data.", "error");
                return;
            }

            try {
                const residentsCollection = collection(db, 'residents');
                const snapshot = await getDocs(residentsCollection);

                if (snapshot.empty) {
                    showMessage("No data to export.", "info");
                    return;
                }

                let csvContent = "Flat Number,Status,Residents\n";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const residentsArray = data.residents;
                    const residentsString = residentsArray.map(r => {
                        // Remove commas from string values to prevent issues in CSV
                        const name = r.name ? r.name.replace(/,/g, '') : '';
                        const contact = r.contact ? r.contact.replace(/,/g, '') : '';
                        const dob = r.dob ? r.dob.replace(/,/g, '') : '';
                        const bloodGroup = r.bloodGroup ? r.bloodGroup.replace(/,/g, '') : '';
                        const occupation = r.occupation ? r.occupation.replace(/,/g, '') : '';
                        const education = r.education ? r.education.replace(/,/g, '') : '';
                        const isPrimary = r.isPrimaryContact ? 'Yes' : 'No';
                        const relation = r.relation ? r.relation.replace(/,/g, '') : 'N/A';
                        return `(Name: ${name}, Contact: ${contact}, DOB: ${dob}, Blood Group: ${bloodGroup}, Occupation: ${occupation}, Education: ${education}, Primary: ${isPrimary}, Relation: ${relation})`;
                    }).join('; ');

                    const sanitizedResidents = `"${residentsString.replace(/"/g, '""')}"`; // Double-quote and escape double quotes
                    csvContent += `${data.flatNumber},${data.flatStatus},${sanitizedResidents}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'merlin_orion_residents.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("Data exported successfully!", "success");

            } catch (error) {
                console.error("Error exporting data:", error);
                showMessage("An error occurred during export. Please try again.", "error");
            }
        });
    }

    const loadData = () => {
        if (!db || !auth.currentUser) {
            showMessage("Database is not ready. Cannot load data.", "error");
            return;
        }

        console.log("Attempting to load data from Firestore...");
        const residentsCollection = collection(db, 'residents');
        onSnapshot(residentsCollection, (snapshot) => {
            console.log(`Received snapshot. Number of documents: ${snapshot.docs.length}`);
            dataTableBody.innerHTML = ''; // Clear table
            if (snapshot.empty) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-gray-500">No data submitted yet.</td>`;
                dataTableBody.appendChild(noDataRow);
            } else {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("Processing document:", data);
                    const residentsArray = data.residents; // CORRECTED LINE
                    const residentsHtml = residentsArray.map(r => `
                        <div class="p-2 bg-gray-50 rounded-md my-2">
                            <strong>Name:</strong> ${r.name}<br>
                            <strong>Contact:</strong> ${r.contact}<br>
                            <strong>DOB:</strong> ${r.dob}<br>
                            <strong>Blood Group:</strong> ${r.bloodGroup}<br>
                            <strong>Occupation:</strong> ${r.occupation || 'N/A'}<br>
                            <strong>Education:</strong> ${r.education || 'N/A'}<br>
                            <strong>Primary Contact:</strong> ${r.isPrimaryContact ? 'Yes' : 'No'}<br>
                            <strong>Relation:</strong> ${r.relation || 'N/A'}
                        </div>
                    `).join('');

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${data.flatNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.flatStatus}</td>
                        <td class="px-6 py-4">
                            ${residentsHtml}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button class="edit-btn py-2 px-4 rounded-md text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 transition-colors" data-id="${data.flatNumber}">Edit</button>
                        </td>
                    `;
                    dataTableBody.appendChild(row);
                });

                // Add event listeners to the new edit buttons
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const flatNumberToEdit = e.target.dataset.id;
                        if (flatNumberToEdit) {
                            formView.classList.remove('hidden');
                            dataView.classList.add('hidden');
                            flatNumberSelect.value = flatNumberToEdit;
                            // Trigger the change event to load the form data
                            flatNumberSelect.dispatchEvent(new Event('change'));
                        }
                    });
                });
            }
        }, (error) => {
            console.error("Error fetching data from Firestore:", error);
            showMessage("Error loading data. Please try again later.", "error");
        });
    };

    async function initializeFirebase() {
        const effectiveConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        if (effectiveConfig) {
            try {
                app = initializeApp(effectiveConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Use the onAuthStateChanged listener to handle the state once it's ready.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in. Now we know the DB is ready for operations.
                        isFirebaseReady = true;
                        console.log("Firebase is ready. User ID:", user.uid);
                        // Initial app setup after successful authentication
                        generateFlatNumbers();
                        createResidentSection();
                        setupEventListeners(); // Call the new function to set up listeners here.
                    } else {
                        // User is signed out or not yet authenticated.
                        isFirebaseReady = false;
                        console.log("User is not authenticated. Waiting for token...");
                    }
                });

                // Temporarily Disabling.
                // Sign in, but don't await. The listener will handle the result.
                // if (initialAuthToken) {
                //     signInWithCustomToken(auth, initialAuthToken)
                //         .then(() => console.log("Sign-in process started with custom token."))
                //         .catch((e) => console.error("Sign-in with custom token failed:", e));
                // } else {
                    signInAnonymously(auth)
                        .then(() => console.log("Sign-in process started anonymously."))
                        .catch((e) => console.error("Anonymous sign-in failed:", e));
                // }

            } catch (e) {
                console.error("Failed to initialize Firebase or sign in:", e);
                showMessage("Failed to initialize Firebase. Please check your configuration.", "error");
            }
        } else {
            showMessage("Firebase configuration not found.", "error");
        }
    }

    initializeFirebase();
</script>

</body>
</html>
