<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merlin Orion Residents Directory</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
.background-collage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; overflow: hidden; }
.background-collage img, .background-collage .gradient { position: absolute; opacity: 0.2; }
.background-collage img { object-fit: cover; }
.image-1 { top: 0; left: 0; width: 60%; height: 70%; }
.image-2 { bottom: 0; right: 0; width: 50%; height: 60%; }
.image-3 { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50%; height: 50%; }
.gradient-top-right { top: 0; right: 0; width: 40%; height: 40%; background: linear-gradient(to bottom left, #a5b4fc, transparent); }
.gradient-bottom-left { bottom: 0; left: 0; width: 40%; height: 40%; background: linear-gradient(to top right, #a5b4fc, transparent); }
.form-container { max-width: 800px; margin: 2rem auto; background-color: rgba(255, 255, 255, 0.9); padding: 2.5rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08); position: relative; z-index: 10; }
.input-group { display: flex; flex-direction: column; }
.input-group label { margin-bottom: 0.5rem; font-weight: 500; color: #4a5568; }
.input-group input, .input-group select { border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; transition: border-color 0.2s; background-color: #fff; }
.input-group input:focus, .input-group select:focus { outline: none; border-color: #4c51bf; box-shadow: 0 0 0 2px rgba(76, 81, 191, 0.2); }
input::placeholder, select option:disabled { color: #a0a0a0; }
.placeholder-color { color: #a0a0a0; }
.resident-section { border: 1px solid #e2e8f0; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem; position: relative; background-color: #f9fafb; }
.btn-group { display: flex; gap: 1rem; margin-top: 1.5rem; }
.table-container { overflow-x: auto; margin-top: 2rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
th { background-color: #f8fafc; font-weight: 600; color: #2d3748; }
.message-box-transition { transition: all 0.3s ease-in-out; opacity: 1; transform: translateY(0); }
.message-box-hidden { opacity: 0; transform: translateY(-10px); }
</style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

<div class="background-collage">
<img src="https://housing-images.n7net.in/012c1500/de401d85f773e7949cdfc64cd6aa27ad/v0/fs.jpeg" alt="Merlin Orion building entrance" class="image-1">
<img src="https://housing-images.n7net.in/4f2250e8/567357597639a7fd15db7f98026bcc11/v0/fs/merlin_orion-paldi-ahmedabad-merlin_group.jpeg" alt="Merlin Orion exterior view" class="image-2">
<img src="https://housing-images.n7net.in/012c1500/6a7cc6d71a141d5d9cf49a58433239f3/v0/fs.jpeg" alt="Merlin Orion common area" class="image-3">
<div class="gradient gradient-top-right"></div>
<div class="gradient gradient-bottom-left"></div>
</div>

<div id="appContainer" class="form-container">
<div id="formView">
<div class="flex flex-col items-center mb-6 text-center">
<h1 class="text-3xl font-bold text-gray-800 mb-2">Merlin Orion Residents Directory</h1>
<p class="text-gray-500">Please provide the details for your flat and all residents.</p>
<button id="googleSignInBtn" class="mt-4 py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Sign in with Google</button>
</div>

<form id="residentForm" class="space-y-6 hidden">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="input-group relative">
<label for="flatNumber" class="text-sm text-gray-600">Flat Number <span class="text-red-500">*</span></label>
<select id="flatNumber" required class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 appearance-none">
<option value="" disabled selected>Select flat number</option>
</select>
<div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 mt-4 flex items-center px-2 text-gray-700">
<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
</svg>
</div>
</div>
<div class="input-group relative">
<label for="flatStatus" class="text-sm text-gray-600">Owner or Tenant? <span class="text-red-500">*</span></label>
<select id="flatStatus" required class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 appearance-none">
<option value="" disabled selected>Select status</option>
<option value="Owner">Owner</option>
<option value="Resident">Resident</option>
</select>
<div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 mt-4 flex items-center px-2 text-gray-700">
<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
</svg>
</div>
</div>
</div>
<div id="residentsContainer" class="mt-8 space-y-6"></div>
<div class="flex items-center justify-between mt-6">
<button type="button" id="showDataBtn" class="py-3 px-4 rounded-md text-sm font-semibold text-gray-800 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">View Submitted Data</button>
<div class="flex gap-4">
<button type="button" id="addResidentBtn" class="py-3 px-4 rounded-md text-sm font-semibold text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors">
<svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Add Resident</button>
<button type="submit" class="py-3 px-4 rounded-md text-sm font-semibold text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors">Submit Form</button>
</div>
</div>
</form>
</div>

<div id="dataView" class="hidden">
<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Submitted Data</h2>
<div class="table-container">
<table id="dataTable" class="min-w-full">
<thead>
<tr>
<th class="px-6 py-3">Flat Number</th>
<th class="px-6 py-3">Status</th>
<th class="px-6 py-3">Residents</th>
<th class="px-6 py-3 text-center">Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="flex justify-center mt-6 gap-4">
<button id="exportDataBtn" class="py-3 px-4 rounded-md text-sm font-semibold text-gray-800 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">Export to CSV</button>
<button id="goBackBtn" class="py-3 px-4 rounded-md text-sm font-semibold text-gray-800 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">Go Back</button>
</div>
</div>

<div id="messageBox" class="hidden mt-4 p-4 rounded-md text-sm message-box-transition" role="alert"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const googleSignInBtn = document.getElementById('googleSignInBtn');
const residentForm = document.getElementById('residentForm');
const addResidentBtn = document.getElementById('addResidentBtn');
const residentsContainer = document.getElementById('residentsContainer');
const messageBox = document.getElementById('messageBox');
const formView = document.getElementById('formView');
const dataView = document.getElementById('dataView');
const showDataBtn = document.getElementById('showDataBtn');
const goBackBtn = document.getElementById('goBackBtn');
const dataTableBody = document.querySelector('#dataTable tbody');
const flatNumberSelect = document.getElementById('flatNumber');
const flatStatusSelect = document.getElementById('flatStatus');
const exportDataBtn = document.getElementById('exportDataBtn');

let residentCount = 0;
let isFirebaseReady = false;

function showMessage(msg, type="info") {
    messageBox.textContent = msg;
    messageBox.className = 'mt-4 p-4 rounded-md text-sm message-box-transition';
    if(type==="success") messageBox.classList.add("bg-green-100","text-green-800");
    else if(type==="error") messageBox.classList.add("bg-red-100","text-red-800");
    else messageBox.classList.add("bg-blue-100","text-blue-800");
    messageBox.classList.remove("hidden");
    setTimeout(()=> messageBox.classList.add("hidden"),4000);
}

function createResidentSection(id) {
    const div = document.createElement('div');
    div.className = 'resident-section';
    div.id = `resident-${id}`;
    div.innerHTML = `
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="input-group"><label>Name <span class="text-red-500">*</span></label><input type="text" required placeholder="Full Name" class="nameInput"></div>
<div class="input-group"><label>Date of Birth</label><input type="date" class="dobInput"></div>
<div class="input-group"><label>Blood Group</label><input type="text" placeholder="A+, B-, etc" class="bloodInput"></div>
<div class="input-group"><label>Occupation</label><input type="text" placeholder="Occupation" class="occupationInput"></div>
<div class="input-group"><label>Education</label><input type="text" placeholder="Education" class="educationInput"></div>
<div class="input-group"><label>Primary Contact</label><input type="text" placeholder="Contact Number" class="contactInput"></div>
<div class="input-group"><label>Relation</label><input type="text" placeholder="Relation" class="relationInput"></div>
</div>
<button type="button" class="mt-2 py-1 px-3 bg-red-500 text-white rounded-md hover:bg-red-600 removeResidentBtn">Remove</button>
`;
    residentsContainer.appendChild(div);
    div.querySelector('.removeResidentBtn').addEventListener('click',()=>div.remove());
}

googleSignInBtn.addEventListener('click', async()=>{
    try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth,provider);
    }catch(err){
        console.error(err);
        showMessage("Google Sign-In failed","error");
    }
});

onAuthStateChanged(auth, user=>{
    if(user){
        residentForm.classList.remove('hidden');
        googleSignInBtn.style.display="none";
        populateFlatNumbers();
    } else {
        residentForm.classList.add('hidden');
        googleSignInBtn.style.display="block";
    }
});

function populateFlatNumbers(){
    for(let i=101;i<=110;i++){
        const option = document.createElement('option');
        option.value=i;
        option.textContent=i;
        flatNumberSelect.appendChild(option);
    }
}

addResidentBtn.addEventListener('click',()=>createResidentSection(++residentCount));

residentForm.addEventListener('submit',async(e)=>{
    e.preventDefault();
    const flatNumber = flatNumberSelect.value;
    const status = flatStatusSelect.value;
    const residents = [];
    document.querySelectorAll('.resident-section').forEach(section=>{
        residents.push({
            name: section.querySelector('.nameInput').value,
            dob: section.querySelector('.dobInput').value,
            blood: section.querySelector('.bloodInput').value,
            occupation: section.querySelector('.occupationInput').value,
            education: section.querySelector('.educationInput').value,
            contact: section.querySelector('.contactInput').value,
            relation: section.querySelector('.relationInput').value
        });
    });
    if(residents.length===0){
        showMessage("Add at least one resident","error");
        return;
    }
    try{
        await setDoc(doc(db,'flats',flatNumber),{
            flatNumber,status,residents,timestamp:serverTimestamp()
        });
        showMessage("Data saved successfully","success");
        residentForm.reset();
        residentsContainer.innerHTML="";
    }catch(err){
        console.error(err);
        showMessage("Failed to save data","error");
    }
});

showDataBtn.addEventListener('click',async()=>{
    formView.classList.add('hidden');
    dataView.classList.remove('hidden');
    dataTableBody.innerHTML="";
    const snapshot = await getDocs(collection(db,'flats'));
    snapshot.forEach(doc=>{
        const data = doc.data();
        const residentsHtml = data.residents.map(r=>r.name).join(", ");
        const tr = document.createElement('tr');
        tr.innerHTML=`<td class="px-6 py-3">${data.flatNumber}</td>
        <td class="px-6 py-3">${data.status}</td>
        <td class="px-6 py-3">${residentsHtml}</td>
        <td class="px-6 py-3 text-center"><button data-flat="${data.flatNumber}" class="editBtn py-1 px-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600">Edit</button></td>`;
        dataTableBody.appendChild(tr);
    });
    document.querySelectorAll('.editBtn').forEach(btn=>{
        btn.addEventListener('click',async()=>{
            const flat = btn.getAttribute('data-flat');
            const docSnap = await getDoc(doc(db,'flats',flat));
            if(docSnap.exists()){
                const data = docSnap.data();
                flatNumberSelect.value = data.flatNumber;
                flatStatusSelect.value = data.status;
                residentsContainer.innerHTML="";
                data.residents.forEach(r=>{
                    createResidentSection(++residentCount);
                    const sec = residentsContainer.lastChild;
                    sec.querySelector('.nameInput').value=r.name;
                    sec.querySelector('.dobInput').value=r.dob;
                    sec.querySelector('.bloodInput').value=r.blood;
                    sec.querySelector('.occupationInput').value=r.occupation;
                    sec.querySelector('.educationInput').value=r.education;
                    sec.querySelector('.contactInput').value=r.contact;
                    sec.querySelector('.relationInput').value=r.relation;
                });
                dataView.classList.add('hidden');
                formView.classList.remove('hidden');
            }
        });
    });
});

goBackBtn.addEventListener('click',()=>{
    dataView.classList.add('hidden');
    formView.classList.remove('hidden');
});

exportDataBtn.addEventListener('click',async()=>{
    const snapshot = await getDocs(collection(db,'flats'));
    const rows = [["Flat Number","Status","Name","DOB","Blood","Occupation","Education","Contact","Relation"]];
    snapshot.forEach(doc=>{
        const data = doc.data();
        data.residents.forEach(r=>{
            rows.push([data.flatNumber,data.status,r.name,r.dob,r.blood,r.occupation,r.education,r.contact,r.relation]);
        });
    });
    const csvContent = "data:text/csv;charset=utf-8,"+rows.map(e=>e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href",encodedUri);
    link.setAttribute("download","residents_directory.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>

</body>
</html>
